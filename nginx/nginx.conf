# nginx/nginx.conf
user  nginx;
worker_processes auto;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    # Docker DNS
    resolver 127.0.0.11 ipv6=off;

    # Базовые оптимизации
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    tcp_nodelay   on;

    # Логи (при желании уменьши уровень до 'error')
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log warn;

    # Сжатие ответов
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1024;
    gzip_types
      text/plain text/css application/json application/javascript
      application/xml application/rss+xml image/svg+xml;

    # Для WebSocket
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Бэкенд (FastAPI/Uvicorn в сервисе 'app' на 8080)
    upstream backend {
        least_conn;
        server app:8080;
        keepalive 32;
    }

    server {
        listen 80 default_server;
        server_name _;

        client_max_body_size 10m;

        # --- Здоровье напрямую проксируем к приложению
        location /health {
            proxy_pass http://backend/health;
            proxy_set_header Host $host;
        }

        # --- Статика
        # (Сейчас отдаём через backend. Если смонтируешь папку со статикой в nginx —
        #  можно заменить на 'root /usr/share/nginx/html;' и убрать proxy_pass.)
        location /static/ {
            proxy_pass http://backend/static/;
            proxy_http_version 1.1;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Долгий кеш статики (можно поменять под себя)
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # --- Основной прокси (API + веб)
        location / {
            proxy_pass         http://backend;
            proxy_http_version 1.1;

            # Проксируем реальные заголовки
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            # WebSocket / streaming
            proxy_set_header   Upgrade           $http_upgrade;
            proxy_set_header   Connection        $connection_upgrade;

            # Таймауты (перевод может занимать время)
            proxy_connect_timeout  5s;
            proxy_send_timeout     60s;
            proxy_read_timeout     300s;  # увеличено, чтобы не обрывать долгие запросы
            send_timeout           60s;

            # Если будут SSE/стримы — отключи буферизацию:
            # proxy_buffering off;
        }

        # (Необязательные базовые security-заголовки; раскомментируй при необходимости)
        # add_header X-Frame-Options DENY always;
        # add_header X-Content-Type-Options nosniff always;
        # add_header Referrer-Policy no-referrer-when-downgrade always;
        # add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        # CSP подбирай осторожно, чтобы не сломать инлайновые стили/скрипты.
    }
}
